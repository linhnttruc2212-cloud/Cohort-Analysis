
--- Pivot table

WITH table_first as (
SELECT customer_id, order_id, transaction_date
    , MIN ( MONTH (transaction_date)) OVER (PARTITION BY customer_id) as first_month
FROM payment_history_17 as his_17
JOIN product as pro
    ON his_17.product_id = pro.product_number
WHERE message_id = 1 --- đơn hàng thành công
    AND sub_category = 'Electricity'
)
, table_month as ( 
    SELECT *
    , MONTH (transaction_date) - first_month as month_n
    FROM table_first
)
, table_retained as (
    SELECT first_month, month_n
        , COUNT (DISTINCT customer_id) as retained_customers
    FROM table_month
    GROUP BY first_month, month_n
)
, table_retention as ( 
    SELECT *
    , original_customers = MAX (retained_customers) OVER ( PARTITION BY first_month)
    , CAST ( retained_customers as decimal )/ MAX (retained_customers) OVER ( PARTITION BY first_month) as pct
    FROM table_retained
)
-- PIVOT
SELECT first_month, original_customers
    , "0" , "1" , "2" , "3", "4" ,"5", "6", "7", "8", "9", "10", "11"
FROM (
    SELECT first_month, month_n, original_customers, CAST ( pct AS DECIMAL (10,2) ) as pct
    FROM table_retention
) as source_table 
PIVOT (
    SUM (pct) -- lấy giá trị tương ứng
    FOR month_n IN ("0" , "1" , "2" , "3", "4" ,"5", "6", "7", "8", "9", "10", "11")
) as pivot_logic
ORDER BY first_month
