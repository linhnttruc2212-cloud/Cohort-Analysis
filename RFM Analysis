--- RFM Analysis: cho sản phẩm hoá đơn điện

--- b1: tính RFM cho từng khách hàng
WITH table_rfm as (
    SELECT customer_id
        , recency = DATEDIFF (day, MAX (transaction_date), '2018-12-31') --- khoảng cách ngày mua hàng gần nhất
        , frequency = COUNT (order_id) --- đếm số đơn hàng
        , monetary = SUM (CAST (final_price AS BIGINT)) -- nếu số quá lớn thì cast về bigint
    FROM (
        SELECT * FROM payment_history_17 UNION SELECT * FROM payment_history_18 ) as his_table
    JOIN product pro
        ON his_table.product_id = pro.product_number
    WHERE message_id = 1 --- chỉ lấy đơn hàng thành công
        AND sub_category = 'Electricity'
    GROUP BY customer_id
    )
    
--- b2: vị trí theo percentile
, table_rank as (
    SELECT *
    , PERCENT_RANK() OVER (ORDER BY recency ASC) as r_rank
    , PERCENT_RANK() OVER (ORDER BY frequency DESC) as f_rank
    , PERCENT_RANK() OVER (ORDER BY monetary DESC) as m_rank
    FROM table_rfm
)
--- b3: nhóm thành 4 tiers cho mỗi chỉ số
, table_tier as (
    SELECT *
    , CASE WHEN r_rank <= 0.25 THEN 1
        WHEN r_rank <= 0.5 THEN 2
        WHEN r_rank <= 0.75 THEN 3
        ELSE 4 END as r_tier
    , CASE WHEN f_rank <= 0.25 THEN 1
        WHEN f_rank <= 0.5 THEN 2
        WHEN f_rank <= 0.75 THEN 3
        ELSE 4 END as f_tier
    ,  CASE WHEN m_rank <= 0.25 THEN 1
        WHEN m_rank <= 0.5 THEN 2
        WHEN m_rank <= 0.75 THEN 3
        ELSE 4 END as m_tier
    FROM table_rank
)
, table_score as (
    SELECT *
    , CONCAT(r_tier, f_tier, m_tier) as rfm_score
    FROM table_tier
--- WHERE f_tier = 3
--- ORDER BY monetary ASC
)
--- b4: phân nhóm theo tổ hợp hành vi

, table_segment as (
    SELECT *
    , CASE
        WHEN rfm_score = 111 THEN 'Best Customers' --- KH tốt nhất
        WHEN rfm_score LIKE '[3-4][3-4][1-4]' THEN 'Lost Bad Customers' --- KH rời bỏ (trên 55 ngày), mua hàng 1,2 lần thôi
        WHEN rfm_score LIKE '[3-4]2[1-4]' THEN 'Lost Customers' --- KH cũng rời bỏ nhưng có valued (F = 3,4,5)
        WHEN rfm_score LIKE '21[1-4]' THEN 'Almost Lost' --- sắp lost những KH này
        WHEN rfm_score LIKE '11[1-4]' THEN 'Loyal Customers' 
        WHEN rfm_score LIKE '[1-2][1-3]1' THEN 'Big Spenders' --- chi nhiều tiền
        WHEN rfm_score LIKE '[1-2]4[1-4]' THEN 'New Customers' --- KH mới nên là giao dịch ít (gần đây nhưng mua ít)
        WHEN rfm_score LIKE '[3-4]1[1-4]' THEN 'Hibernating' --- ngủ đông trước đó từng rất là tốt
        WHEN rfm_score LIKE '[1-2][2-3][2-4]' THEN 'Potential Loyalists' --- có tiềm năng
        ELSE 'unknown' END as segment
    FROM table_score
)
SELECT segment
    , COUNT (customer_id) as number_customers
FROM table_segment
GROUP BY segment
ORDER BY number_customers DESC
